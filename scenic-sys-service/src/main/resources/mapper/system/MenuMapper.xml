<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jw.sys.dao.MenuDao">
  <resultMap id="BaseResultMap" type="com.jw.sys.bean.entity.Menu">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="code" jdbcType="VARCHAR" property="code" />
    <result column="pcode" jdbcType="VARCHAR" property="pcode" />
    <!--<result column="pcodes" jdbcType="VARCHAR" property="pcodes" />-->
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="icon" jdbcType="VARCHAR" property="icon" />
    <result column="url" jdbcType="VARCHAR" property="url" />
    <result column="num_sort" jdbcType="INTEGER" property="numSort"/>
    <result column="level" jdbcType="INTEGER" property="level" />
    <result column="is_menu" jdbcType="INTEGER" property="isMenu" />
    <result column="tips" jdbcType="VARCHAR" property="tips" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <!--<result column="isopen" jdbcType="INTEGER" property="isopen" />-->
    <result column="creator" property="creator" jdbcType="INTEGER"/>
    <result column="create_time" property="createTime" jdbcType="DATE"/>
    <result column="mender" property="mender" jdbcType="INTEGER"/>
    <result column="modify_time" property="modifyTime" jdbcType="DATE"/>
    <result column="is_delete" property="isDelete" />
    <result column="type" property="type"/>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, code, pcode , name, icon, url, num_sort, level, is_menu, tips, status ,creator,create_time,mender,modify_time,is_delete,type
  </sql>
  <select id="selectById" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from sys_menu
    where id = #{menuId,jdbcType=INTEGER}
    and is_delete=0
  </select>
  <select id="selectPMenuByPcode" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from sys_menu
    where code = #{pcode,jdbcType=VARCHAR}
    and is_delete=0
  </select>
  <select id="selectSubmenu" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from sys_menu
    where is_delete=0
  </select>
  <select id="selectNextLevelMenu" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      add by tanqiaomu
                     取某一菜单的所有下一级子菜单
    -->
    select
    <include refid="Base_Column_List" />
    from sys_menu
    where pcode = #{pcode}
    and is_delete=0
    and status = 1
  </select>
  <update id="delMenuById" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    UPDATE  sys_menu
    set is_delete=1,
    mender=#{mender,jdbcType=INTEGER},
    modify_time=NOW()
    where id = #{id,jdbcType=INTEGER}
  </update>
  <insert id="insert" parameterType="com.jw.sys.bean.entity.Menu" useGeneratedKeys="true">
    insert into sys_menu (
    <if test="code != null">
    code,
    </if>
    <if test="pcode != null">
    pcode,
    </if>
    <if test="name != null">
    name,
    </if>
    <if test="icon != null">
    icon,
    </if>
    <if test="url != null">
    url,
    </if>
    <if test="numSort != null">
    num_sort,
    </if>
    <if test="level != null">
    level,
    </if>
    <if test="isMenu != null">
    is_menu,
    </if>
    <if test="tips != null">
    tips,
    </if>
    <if test="status != null">
    status,
    </if>
    <if test="creator != null">
    creator,
    </if>
    create_time,
    <if test="mender != null">
    mender,
    </if>
    <if test="type != null">
      type,
    </if>
    modify_time,
    is_delete
      )
    values (
    <if test="code != null">
      #{code,jdbcType=VARCHAR},
    </if>
    <if test="pcode != null">
      #{pcode,jdbcType=VARCHAR},
    </if>
    <if test="name != null">
      #{name,jdbcType=VARCHAR},
    </if>
    <if test="icon != null">
      #{icon,jdbcType=VARCHAR},
    </if>
    <if test="url != null">
      #{url,jdbcType=VARCHAR},
    </if>
    <if test="numSort != null">
      #{numSort,jdbcType=INTEGER},
    </if>
    <if test="level != null">
      #{level,jdbcType=INTEGER},
    </if>
    <if test="isMenu != null">
      #{isMenu,jdbcType=INTEGER},
    </if>
    <if test="tips != null">
      #{tips,jdbcType=VARCHAR},
    </if>
    <if test="status != null">
      #{status,jdbcType=INTEGER},
    </if>
    <if test="creator != null">
      #{creator,jdbcType=INTEGER},
    </if>
      NOW(),
    <if test="mender != null">
      #{mender,jdbcType=INTEGER},
    </if>
    <if test="type != null">
      #{type,jdbcType=INTEGER},
    </if>
      NOW(),
      0
      )
  </insert>
  <insert id="insertSelective" parameterType="com.jw.sys.bean.entity.Menu">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Integer">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into sys_menu
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="code != null">
        code,
      </if>
      <if test="pcode != null">
        pcode,
      </if>
     <!-- <if test="pcodes != null">
        pcodes,
      </if>-->
      <if test="name != null">
        name,
      </if>
      <if test="icon != null">
        icon,
      </if>
      <if test="url != null">
        url,
      </if>
      <if test="numSort != null">
        num_sort,
      </if>
      <if test="level != null">
        level,
      </if>
      <if test="isMenu != null">
        is_menu,
      </if>
      <if test="tips != null">
        tips,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="type != null">
        type,
      </if>
     <!-- <if test="isopen != null">
        isopen,
      </if>-->
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=INTEGER},
      <if test="code != null">
        #{code,jdbcType=VARCHAR},
      </if>
      <if test="pcode != null">
        #{pcode,jdbcType=VARCHAR},
      </if>
     <!-- <if test="pcodes != null">
        #{pcodes,jdbcType=VARCHAR},
      </if>-->
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="icon != null">
        #{icon,jdbcType=VARCHAR},
      </if>
      <if test="url != null">
        #{url,jdbcType=VARCHAR},
      </if>
      <if test="numSort != null">
        #{num,jdbcType=INTEGER},
      </if>
      <if test="level != null">
        #{level,jdbcType=INTEGER},
      </if>
      <if test="ismenu != null">
        #{ismenu,jdbcType=INTEGER},
      </if>
      <if test="tips != null">
        #{tips,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        #{type,jdbcType=INTEGER},
      </if>
     <!-- <if test="isopen != null">
        #{isopen,jdbcType=INTEGER},
      </if>-->
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.jw.sys.bean.entity.Menu">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sys_menu
    <set>
      <if test="code != null">
        code = #{code,jdbcType=VARCHAR},
      </if>
      <if test="pcode != null">
        pcode = #{pcode,jdbcType=VARCHAR},
      </if>
      <!--<if test="pcodes != null">
        pcodes = #{pcodes,jdbcType=VARCHAR},
      </if>-->
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="icon != null">
        icon = #{icon,jdbcType=VARCHAR},
      </if>
      <if test="url != null">
        url = #{url,jdbcType=VARCHAR},
      </if>
      <if test="numSort != null">
        num_sort = #{numSort,jdbcType=INTEGER},
      </if>
      <if test="level != null">
        level = #{level,jdbcType=INTEGER},
      </if>
      <if test="isMenu != null">
        is_menu = #{isMenu,jdbcType=INTEGER},
      </if>
      <if test="tips != null">
        tips = #{tips,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        type = #{type,jdbcType=INTEGER},
      </if>
      <!--<if test="isopen != null">
        isopen = #{isopen,jdbcType=INTEGER},
      </if>-->
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateById" parameterType="com.jw.sys.bean.entity.Menu">
      update sys_menu
      set
      <if test="code != null">
      code = #{code,jdbcType=VARCHAR},
      </if>
      <if test="pcode != null">
      pcode = #{pcode,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
      name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="url != null">
      url = #{url,jdbcType=VARCHAR},
      </if>
      <if test="numSort != null">
      num_sort = #{numSort,jdbcType=INTEGER},
      </if>
      <if test="level != null">
      level=#{level,jdbcType=INTEGER},
      </if>
      <if test="mender != null">
      mender=#{mender,jdbcType=INTEGER},
      </if>
      <if test="status != null">
      status=#{status,jdbcType=INTEGER},
      </if>
    <if test="type != null">
      type=#{type,jdbcType=INTEGER},
    </if>
      modify_time=NOW()
    where id = #{id,jdbcType=INTEGER}
  </update>

  <update id="updateByCode" parameterType="com.jw.sys.bean.entity.Menu">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sys_menu
    set code = #{code,jdbcType=VARCHAR},
    pcode = #{pcode,jdbcType=VARCHAR},
   /* pcodes = #{pcodes,jdbcType=VARCHAR},*/
    name = #{name,jdbcType=VARCHAR},
    url = #{url,jdbcType=VARCHAR},
    num_sort = #{numSort,jdbcType=INTEGER},
    level = #{level,jdbcType=INTEGER},
    is_menu = #{isMenu,jdbcType=INTEGER},
    mender=#{mender,jdbcType=INTEGER},
    modify_time=NOW()
    where code = #{code,jdbcType=VARCHAR}
  </update>


  <select id="selectMenus" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from sys_menu
    where 1 = 1
    <if test="menuName != null and menuName != ''">
      and (name like CONCAT('%',#{menuName},'%') or code like CONCAT('%',#{menuName},'%'))
    </if>
    <if test="level != null and level != ''">
      and level = #{level}
    </if>
    and is_delete=0  order by modify_time  desc
  </select>



  <select id="menuTreeList" resultType="com.jw.sys.bean.vo.ZTreeNode">
    SELECT
    m1.id AS id,
    (
    CASE
    WHEN (m2.id = 0 OR m2.id IS NULL) THEN
    0
    ELSE
    m2.id
    END
    ) AS pId,
    m1. NAME
    AS NAME/*,
    (
    CASE
    WHEN (m2.id = 0 OR m2.id IS NULL) THEN
    'true'
    ELSE
    'false'
    END
    ) as isOpen*/
    FROM
    sys_menu m1
    LEFT JOIN sys_menu m2 ON m1.pcode = m2. CODE
    where m1.is_delete=0
    ORDER BY
    m1.id ASC
  </select>

  <select id="menuTreeListByMenuIds" resultType="com.jw.sys.bean.vo.ZTreeNode">
    SELECT
    m1.id AS id,
    (
    CASE
    WHEN (m2.id = 0 OR m2.id IS NULL) THEN
    0
    ELSE
    m2.id
    END
    ) AS pId,
    m1. NAME AS NAME,
    (
    CASE
    WHEN (m3.ID = 0 OR m3.ID
    IS NULL) THEN
    'false'
    ELSE
    'true'
    END
    ) "checked"
    FROM
    sys_menu m1
    LEFT JOIN
    sys_menu m2
    ON m1.pcode = m2. CODE
    left join (
    SELECT
    ID
    FROM
    sys_menu
    WHERE
    ID IN
    <foreach close=")" collection="list" index="index" item="i" open="(" separator=",">
      #{i}
    </foreach>
    ) m3 on m1.id = m3.id
    where m1.is_delete=0
    ORDER BY
    m1.id ASC
  </select>

  <update id="deleteRelationByMenu">
    update  sys_relation
    set is_delete=1,
    mender=#{mender},
    modify_time=NOW()
    where menuid = #{menuId}
  </update>

  <select id="getResUrlsByRoleId" resultMap="BaseResultMap">
    select
    url
     from
    sys_menu_vs_role rel
    inner join sys_menu m on rel.sys_menu_id = m.id
    where rel.sys_role_id = #{roleId}
    and m.is_delete=0 and rel.is_delete=0 and m.status=1
  </select>

  <select id="getMenuNameByCode" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" /> from
    sys_menu
    where code = #{code}
    and is_delete=0
  </select>
  <select id="getMenusByRoleIds" resultType="com.jw.sys.bean.vo.MenuNode" parameterType="java.util.Map">
    SELECT
    m1.id AS id,
    m1.icon AS icon,
    (
    CASE
    WHEN (m2.id = 0 OR m2.id IS NULL) THEN
    0
    ELSE
    m2.id
    END
    ) AS parentId,
    m1.name as name,
    m1.url as url,
    m1.level as level,
    m1.is_menu as isMenu,
    m1.num_sort as numSort
    FROM
    sys_menu m1
    LEFT JOIN sys_menu m2 ON m1.pcode = m2.code
    INNER JOIN (
    SELECT
    id
    FROM
    sys_menu
    WHERE
    id IN (
    SELECT
    sys_menu_id
    FROM
    sys_menu_vs_role rela
    WHERE
    rela.sys_role_id IN
    <foreach collection="list" index="index" item="i" open="(" separator="," close=")">
      #{i}
    </foreach>
    and rela.is_delete = '0'
    )
    ) m3 ON m1.id = m3.id
    where m1.is_menu = 1 and m1.status=1
    and m1.is_delete=0
    order by level,numSort asc
  </select>

  <select id="getMenuIdsByRoleId" resultType="int">
    select sys_menu_id from
    sys_menu_vs_role where sys_role_id = #{roleId}
    and is_delete=0
  </select>

</mapper>